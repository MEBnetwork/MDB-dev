---
title: "SoilTemp Summary Report"
output:
  pdf_document:
    latex_engine: xelatex
keep_tex: true
header-includes:
  - \usepackage{fontspec}
  - \setmainfont{Arial}
  - \usepackage{fancyhdr}
  - \usepackage{graphicx}
  - \usepackage{tikz}
  - \usepackage{geometry}
  - \usepackage{xcolor}
  - \usepackage{fvextra} # Ajout du package fvextra
params:
  #location
  choiceconcoor: NA
  continent: NA
  country: NA
  alt: [NA, NA]
  lat: [NA, NA]
  long: [NA, NA]
  #experiments
  expname: NA
  manip: NA
  insitu: NA
  climvarmanip: NA
  citizens: NA
  #sites
  sitname: NA
  habitat: NA
  #loggers
  logbrand: NA
  logtype: NA
  logage: NA
  logshield: NA
  loghomeshield: NA
  #timeseries
  climvar: NA
  accuracy: [NA, NA]
  tempres: [NA, NA]
  sensheight: [NA, NA]
  sensrange: [NA, NA]
  daterangets: [NA, NA]
  licts: NA
  #vegetation 
  sampmeth: NA
  multilayers: NA
  plotsize: [NA, NA]
  daterangeveg: [NA, NA]
  licveg: NA
  #queries
  queryloc: NA
  queryexp: NA
  querysit: NA
  querylog: NA
  queryts: NA
  queryveg: NA
  #table
  tableloc: NA
  tableexp: NA
  tablesit: NA
  tablelog: NA
  tablets: NA
  tableveg: NA
---



Date of the ask : `r Sys.Date()`



## Filter Selection 

### Location: 
```{r, echo=FALSE, results='asis', message=FALSE}
# Fonction pour envelopper le texte avec une largeur maximale donnée
wrap_text <- function(text, width = 80) {
  wrapped <- strwrap(text, width = width)
  paste(wrapped, collapse = "\n")
}

# Condition pour afficher en fonction du choix
if (params$choiceconcoor == "1") {
  continent_text <- wrap_text(paste("Continent: ", paste(params$continent, collapse = ", ")))
  country_text <- wrap_text(paste("Country: ", paste(params$country, collapse = ", ")))
  
  cat(continent_text, "\n\n")
  cat(country_text, "\n\n")
} else {
  lat_text <- wrap_text(paste("Latitude: between ", params$lat[1], " and ", params$lat[2]))
  long_text <- wrap_text(paste("Longitude: between ", params$long[1], " and ", params$long[2]))
  
  cat(lat_text, "\n")
  cat(long_text, "\n")
}

# Afficher l'altitude avec un enveloppement du texte
alt_text <- wrap_text(paste("Altitude: between ", params$alt[1], " and ", params$alt[2]))
cat(alt_text, "\n")

```


### Experiments:

Name: `r params$expname`

Manip: `r params$manip`

In situ: `r params$insitu`

Climatic Variable manipulated: `r params$climvarmanip`

Citizens science sampling: `r params$citizens`


### Sites:

Name: `r params$sitname`

Habitat: `r params$habitat`


### Loggers:

Brand: `r params$logbrand`

Type: `r params$logtype`

Age: `r params$logage`

Covered by a shield: `r params$logshield`

Homemade Shield: `r params$loghomeshield`


### Timeseries:

Climatic Variable: `r params$climvar`

Accuracy of measurements: Between `r params$accuracy[1]` and `r params$accuracy[2]`

Temporal resolution: Between `r params$tempres[1]` and `r params$tempres[2]`

Height of measurements: Between `r params$sensheight[1]` and `r params$sensheight[2]`

Range of height measured: Between `r params$sensrange[1]` and `r params$sensrange[2]`

Date: Between `r params$daterangets[1]` and `r params$daterangets[2]`

Licence: `r params$licts`


### Vegetation:

Sampling method: `r params$sampmeth`

Several canopy layers: `r params$multilayers`

Size of the plot: Between `r params$plotsize[1]` and `r params$plotsize[2]`

Date: Between `r params$daterangeveg[1]` and `r params$daterangeveg[2]`

Licence: `r params$licveg`


## Visualization

```{r, echo=FALSE}
timeseries = params$tablets %>% collect()
date_start = timeseries%>%pull(mts_date_start)
date_stop = timeseries%>%pull(mts_date_stop)



# Créer une séquence de dates couvrant toute la période d'observation
all_dates <- seq(min(date_start), max(date_stop), by = "month")

# Calculer le nombre d'observations actives pour chaque date
observation_ts <- sapply(all_dates, function(date) {
  sum(date_start <= date & date_stop >= date)
})

# Créer un data frame avec les résultats
observation_ts <- data.frame(date = all_dates, count = observation_ts)

# Compter les occurrences par date
observation_veg <- aggregate(id ~ mvs_date, params$tableveg, length)
colnames(observation_veg) <- c("date", "count")


nbmaxts = max(observation_ts$count)
nbmaxveg = max(observation_veg$count)

# Créer un facteur d'échelle pour ajuster les barres par rapport à la ligne
scale_factor <- nbmaxts / nbmaxveg


ggplot() + 
  geom_line(data = observation_ts, aes(x = date, y = count), color = "#CF0A0A") + 
  geom_bar(data = observation_veg, aes(x = date, y = count*scale_factor), stat = "identity", fill = "#50AB42", alpha = 0.5) + 
  scale_y_continuous(name = "Number of timeseries observation", 
                     sec.axis = sec_axis(~./scale_factor, name = "Number of vegetation surveys")) + 
  labs(title = "Number of timeseries and vegetation surveys", x = "Date", y = "Number of observations") + 
  theme(axis.title.y.right = element_text(color = "#326B29"),
        axis.text.y.right = element_text(color = "#326B29"), 
        axis.title.y.left = element_text(color = "#6B0505"), 
        axis.text.y.left = element_text(color = "#6B0505"))
```











